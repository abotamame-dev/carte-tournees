<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte de tourn√©e</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="style.css" />
  <style>#map { height: 100vh; }</style>
</head>
<body>
  <div class="map-toolbar">
    <select id="tourSelect"></select>
    <button id="backBtn">Accueil</button>
  </div>
  <div id="map"></div>
  <div class="legend">
    <span class="dot hub"></span> Hub
    &nbsp;&nbsp;
    <span class="dot stop"></span> Stop
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="tours.js"></script>
  <script>
    function getParam(name) { const u = new URLSearchParams(location.search); return u.get(name); }
    function isHub(rec) { return rec.index === 1 || (rec.client||'').toLowerCase().includes('hub'); }

    const toursData = window.TOURS_DATA || {};
    const tourNames = Object.keys(toursData).sort();
    const sel = document.getElementById('tourSelect');
    sel.innerHTML = tourNames.map(t => `<option value="${encodeURIComponent(t)}">${t}</option>`).join('');
    const initialTour = decodeURIComponent(getParam('tour') || (tourNames[0] || ''));
    sel.value = encodeURIComponent(initialTour);

    const map = L.map('map', { zoomControl: true });
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' });
    osm.addTo(map);

    let layerGroup = L.layerGroup().addTo(map);

    function renderTour(name) { 
      layerGroup.clearLayers();
      const data = toursData[name] || [];
      if (!data.length) return;
      const latlngs = [];
      data.forEach(rec => { 
        const lat = rec.lat, lon = rec.lon;
        if (typeof lat !== 'number' || typeof lon !== 'number') return;
        latlngs.push([lat, lon]);
        const popup = `<b>Index:</b> ${rec.index ?? ''}<br>` +
                      `<b>Client:</b> ${(rec.client||'')}` +
                      (rec.adresse ? `<br><b>Adresse:</b> ${rec.adresse}` : '') +
                      (rec.cp || rec.ville ? `<br><b>Ville:</b> ${[rec.cp, rec.ville].filter(Boolean).join(' ')}` : '');
        if (isHub(rec)) { 
          L.marker([lat, lon], { title: 'Hub',
            icon: L.icon({
              iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x-red.png',
              iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x-red.png',
              iconSize: [25,41], iconAnchor:[12,41], popupAnchor:[1,-34],
              shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png', shadowSize:[41,41]
            }) 
          }).bindPopup(popup).addTo(layerGroup);
        } else { 
          const m = L.circleMarker([lat, lon], { radius: 6, color: '#0d6efd', fill:true, fillOpacity:.9 }).addTo(layerGroup);
          if (rec.index != null) m.bindTooltip(String(rec.index), {permanent:false, direction:'top', offset:[0,-6]});
          m.bindPopup(popup);
        }
      });
      if (latlngs.length) {
        map.fitBounds(latlngs, { padding: [40,40] });
        if (latlngs.length >= 2) {
          L.polyline(latlngs, { color: '#0d6efd', weight: 3, opacity: .7 }).addTo(layerGroup);
        }
      }
    }

    renderTour(initialTour);

    sel.addEventListener('change', () => {
      const name = decodeURIComponent(sel.value);
      renderTour(name);
      history.replaceState(null, '', `?tour=${encodeURIComponent(name)}`);
    });

    document.getElementById('backBtn').addEventListener('click', () => location.href = 'index.html');
  </script>
</body>
</html>
